<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="https://kurorosuke.github.io/homepoti/favicon.ico" />
    <link rel="stylesheet" href="main.css" />
    <title>褒めポチ</title>

    <!-- ★ CSP: 外部JSをGoogle/Firebase/CDN(jsDelivr)のみに制限。inlineは許可（既存onclick等のため） -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdn.jsdelivr.net;
                   img-src 'self' https: data: blob:;
                   style-src 'self' 'unsafe-inline';
                   connect-src *;
                   media-src 'self' data:;">

    <!-- Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- ★ DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

    <script src="connectDB.js"></script>
</head>
<body>
    <!-- 効果音（任意） -->
    <audio id="ordersSound" preload="auto">
      <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>

    <!-- 未ログイン -->
    <div style="text-align: center;" id="notSigned">
      <h3>ログインしてください</h3>
      <button onclick="loginWithGoogle()">Googleでログイン</button>
      <button onclick="loginWithMail()">メールでログイン</button>
      <button onclick="SignUpWithMail()">メールで新規登録</button>
    </div>

    <!-- 投稿一覧: ★ 未ログインでも表示 -->
    <div id="viewScreen" style="overflow-y:scroll;height:calc(100vh - 70px);display:none;">
        <button id="loadMoreBtn" style="display:none;">さらに読み込む</button>
    </div>

    <!-- 投稿する -->
    <div id="postScreen" style="display:none;">
        <div class="InputForm">
          <textarea id="postTextInput" placeholder="今日はなにした？" maxlength="280"></textarea>
          <div id="charCount">0</div>
          <input type="file" id="fileInput" accept="image/*" onchange="viewImageCanvas()">
          <canvas id="canvas" style="display:none;"></canvas>
          <button onclick="post()">投稿</button>
        </div>
    </div>

    <!-- サービス管理 -->
    <div id="servicesScreen" style="display:none;">
      <div class="InputForm">
        <h3>サービスを登録</h3>
        <input id="svcTitle" class="svc-input" type="text" placeholder="タイトル" maxlength="40">
        <textarea id="svcDesc" class="svc-input" placeholder="説明" maxlength="200"></textarea>
        <input id="svcPrice" class="svc-input" type="number" min="0" step="1" placeholder="価格（コイン）">
        <label class="svc-inline"><input id="svcActive" type="checkbox" checked> 公開</label>
        <button id="svcAddBtn">追加 / 更新</button>
      </div>

      <div class="InputForm">
        <h3>自分のサービス</h3>
        <div id="myServicesList" class="svc-list"></div>
      </div>

      <div class="InputForm">
        <h3>受けた注文 <span id="ordersBadge" class="badge" style="display:none;">0</span></h3>
        <div id="myOrdersList" class="order-list"></div>
      </div>
    </div>

    <!-- マーケット -->
    <div id="marketScreen" style="display:none;">
      <!-- ★ コインHUDはマーケットだけで表示 -->
      <div id="coinHUD" aria-label="coin HUD" style="display:none;">
        🪙 <span id="coinBalance">0</span>
      </div>

      <div class="InputForm">
        <h3>マーケット</h3>
        <div id="marketList" class="svc-list"></div>
      </div>
    </div>

    <!-- ナビ -->
    <div id="bottomNav" style="display: none;">
        <div class="navigater">
          <button class="nav_buttons" onclick="switchTab('view')" aria-label="ViewScreen">
              <img src="../Icons/view.png" alt="view" class="nav_icon">
          </button>
        </div>
        <div class="divider"></div>
        <div class="navigater">
          <button class="nav_buttons" onclick="switchTab('post')" aria-label="PostScreen">
              <img src="../Icons/post.png" alt="post" class="nav_icon">
          </button>
        </div>
        <div class="divider"></div>
        <div class="navigater">
          <button class="nav_buttons" onclick="switchTab('services')" aria-label="ServicesScreen">
              <img src="../Icons/service.png" alt="services" class="nav_icon">
          </button>
        </div>
        <div class="divider"></div>
        <div class="navigater">
          <button class="nav_buttons" onclick="switchTab('market')" aria-label="MarketScreen">
              <img src="../Icons/market.png" alt="market" class="nav_icon">
          </button>
        </div>
    </div>

    <script src="main.js"></script>
</body>
</html>
